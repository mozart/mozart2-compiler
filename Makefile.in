include ../Makefile.vars
include $(TOPDIR)/Makefile.rules

COMPILER = $(OZLIB)/compiler

SOURCES = InsertAll.oz Compiler.oz Misc.oz Reporter.oz ParseOz.oz \
          FormatStrings.oz Builtins.oz CoreLanguage.oz Annotate.oz \
          StaticAnalysis.oz POTypes.oz RegSet.oz CodeGen.oz CodeStore.oz \
          CodeEmitter.oz BindingAnalysis.oz TupleSyntax.oz Unnester.oz \
          UnnestFD.oz Assembler.oz Interface.oz \
          GenericInterface.oz QuietInterface.oz

LIBSOURCES = $(SOURCES:%.oz=$(COMPILER)/%.oz) \
             $(COMPILER)/Opcodes.oz $(COMPILER)/Version.oz \
             $(COMPILER)/CompilerPanel.oz
SRCS = $(SOURCES:%.oz=$(SRCDIR)/compiler/%.oz) $(SRCDIR)/compiler/Opcodes.m4oz

all:: Version.oz Opcodes.oz

install:: $(COMPILER) $(LIBSOURCES)

Version.oz: $(SRCS)
        ($(ECHO) 'OZVERSION = '\'$(OZVERSION)\'; \
        $(ECHO) 'DATE = '\'`date '+%h %d 19%y (%T)'`\') > Version.oz

Opcodes.oz: $(SRCDIR)/compiler/Opcodes.m4oz $(TOPDIR)/include/instrDefs.m4
        $(M4) -DOZINCDIR=$(TOPDIR)/include \
                < $(SRCDIR)/compiler/Opcodes.m4oz > Opcodes.oz

$(COMPILER):
        $(INSTALLDIR) $@

$(COMPILER)/%.oz: %.oz
        $(INSTALLSRC) '$<' '$@'

tags:
        etags --language=none \
        --regex='/[ \t]*proc\>[^{\n]*{!?\([A-Z][A-Za-z0-9_]*\|`.+`\)/\1/' \
        --regex='/[ \t]*fun\>[^{\n]*{!?\([A-Z][A-Za-z0-9_]*\|`.+`\)/\1/' \
        --regex='/[ \t]*class[ \t]+!?\([A-Z][A-Za-z0-9_]*\|`.+`\)/\1/' \
        --regex='/[ \t]*meth\([ \t]+\|[ \t]*![ \t]*\)\([A-Za-z0-9][A-Za-z0-9_]*\|`.+`|'\''.+'\''\)/\2/' \
        $(SRCS)

clean::
        $(RM) TAGS

realclean::
        $(RM) Opcodes.oz Version.oz
